#include "basetextelement.h"
#include "anchorjig.h"
#include <QBuffer>
#include <QPen>
#include <QPainter>

BaseTextElement::BaseTextElement(QGraphicsItem *parent) :
    QGraphicsItem(parent),
    UiElement(StringElementType, this)
{
    m_textString = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    m_fontSize = 30;
}

void BaseTextElement::remember()
{
    m_rememberedPos = pos();
}

void BaseTextElement::restore()
{
    setPos(m_rememberedPos);
}

void BaseTextElement::forget()
{
    m_rememberedPos = pos();
    restore();
}

void BaseTextElement::morphWithJigShape(ElementJig *jig)
{
    switch (jig->jigType()) {
    case AnchorJigType:
        setPos(((AnchorJig*)jig)->anchor());
        break;
    default:
        break;
    }
}

void BaseTextElement::initializeJigShape(ElementJig *jig)
{
    auto rect = boundingRect();
    rect.moveTopLeft(pos());
    switch (jig->jigType()) {
    case AnchorJigType:
        ((AnchorJig*)jig)->setRect(rect.toAlignedRect());
        break;
    default:
        break;
    }
}

int BaseTextElement::applicableJigs()
{
    return AnchorJigType;
}

QByteArray BaseTextElement::dumpState()
{
    QBuffer buf;
    QDataStream ds(&buf);
    ds << pos() << m_textString;
    QByteArray ret = buf.readAll();
    return ret;
}

void BaseTextElement::undumpState(QByteArray state)
{
    QBuffer buf(&state);
    QDataStream ds(&buf);
    QPointF pos;
    ds >> pos >> m_textString;
    setPos(pos);
}

QString BaseTextElement::descriptiveText()
{
    return QObject::tr("String \"%1\"").arg(m_textString.left(8));
}

void BaseTextElement::setText(QString text)
{
    m_textString = text;
    prepareGeometryChange();
}

void BaseTextElement::setFontSize(int size) {
    m_fontSize = size;
    prepareGeometryChange();
}

void BaseTextElement::setPen(QPen pen) {
    m_pen = pen;
    prepareGeometryChange();
}

QRectF BaseTextElement::boundingRect() const
{
    auto halfPen = m_pen.widthF() / 2;
    return {-halfPen, -halfPen, m_textString.size() * m_fontSize + halfPen, m_fontSize + halfPen};
}

void BaseTextElement::paint(QPainter *painter, const QStyleOptionGraphicsItem *option, QWidget *widget)
{
    painter->setPen(m_pen);

    painter->scale(1, -1);
    for (int i = 0; i < m_textString.size(); i++) {
        QVector<float>* charFont;
        auto ascii = m_textString[i].toLatin1();
        if (vectorFont.contains(ascii)) {
            charFont = &vectorFont[ascii];
        } else {
            charFont = &vectorFont['0'];
        }

        for (int j = 0; j < charFont->size(); j += 4) {
            painter->drawLine(QPointF{charFont->value(j) * m_fontSize, charFont->value(j + 1) * m_fontSize},
                              QPointF{charFont->value(j + 2) * m_fontSize, charFont->value(j + 3) * m_fontSize});
        }

        painter->translate(m_fontSize, 0);
    }
}

QMap<int, QVector<float>> BaseTextElement::vectorFont = {
    { 33, { 0, -0.9, 0, -1, 0, 0, 0, -0.75 } },
    { 34, { 0.15, 0, 0.15, -0.25, 0.45, -0.25, 0.45, 0 } },
    { 35, { 0.2, 0, 0.2, -1, 0, -0.33, 0.6, -0.33, 0.4, 0, 0.4, -1, 0, -0.66, 0.6, -0.66 } },
    { 37, { 0, 0, 0, -0.25, 0.15, 0, 0.15, -0.25, 0, -0.25, 0.15, -0.25, 0, 0, 0.15, 0, 0.6, -0.75, 0.45, -0.75, 0.6, -1, 0.45, -1, 0.45, -1, 0.45, -0.75, 0.6, -1, 0.6, -0.75, 0, -1, 0.6, 0 } },
    { 38, { 0.2, -0.5, 0.2, 0, 0, -0.5, 0, -1, 0.6, -1, 0, -1, 0.2, -0.5, 0.6, -1, 0.6, -1, 0.6, -0.7, 0.2, 0, 0.5, 0, 0.5, -0.5, 0.5, 0, 0, -0.5, 0.5, -0.5 } },
    { 39, { 0.3, -0.25, 0.45, 0 } },
    { 40, { 0.45, 0, 0.15, -0.25, 0.15, -0.25, 0.15, -0.75, 0.45, -1, 0.15, -0.75 } },
    { 41, { 0.15, 0, 0.45, -0.25, 0.45, -0.25, 0.45, -0.75, 0.15, -1, 0.45, -0.75 } },
    { 42, { 0.3, -1, 0.3, 0, 0.6, -0.5, 0, -0.5, 0.5, -0.1, 0.1, -0.9, 0.5, -0.9, 0.1, -0.1 } },
    { 43, { 0, -0.5, 0.6, -0.5, 0.3, -0.9, 0.3, -0.1 } },
    { 44, { 0, -1, 0.15, -0.75 } },
    { 45, { 0, -0.5, 0.6, -0.5 } },
    { 46, { 0, -0.9, 0, -1 } },
    { 47, { 0.6, 0, 0, -1 } },
    { 48, { 0, -1, 0, 0, 0.6, -1, 0.6, 0, 0.6, 0, 0, 0, 0.6, -1, 0, -1 } },
    { 49, { 0.3, -1, 0.3, 0 } },
    { 50, { 0.6, 0, 0, 0, 0.6, 0, 0.6, -0.5, 0, -0.5, 0.6, -0.5, 0, -0.5, 0, -1, 0.6, -1, 0, -1 } },
    { 51, { 0.6, 0, 0, 0, 0.6, -1, 0.6, 0, 0, -1, 0.6, -1, 0, -0.5, 0.6, -0.5 } },
    { 52, { 0, -0.5, 0, 0, 0.6, -1, 0.6, 0, 0.6, -0.5, 0, -0.5 } },
    { 53, { 0, 0, 0.6, 0, 0, 0, 0, -0.5, 0.6, -0.5, 0, -0.5, 0.6, -1, 0.6, -0.5, 0.6, -1, 0, -1 } },
    { 54, { 0, 0, 0.6, 0, 0.6, -0.5, 0, -0.5, 0.6, -1, 0.6, -0.5, 0.6, -1, 0, -1, 0, 0, 0, -1 } },
    { 55, { 0, 0, 0.6, 0, 0.6, -1, 0.6, 0 } },
    { 56, { 0, 0, 0.6, 0, 0.6, -1, 0.6, 0, 0, 0, 0, -1, 0.6, -1, 0, -1, 0.6, -0.5, 0, -0.5 } },
    { 57, { 0, 0, 0.6, 0, 0.6, -1, 0.6, 0, 0.6, -1, 0, -1, 0.6, -0.5, 0, -0.5, 0, 0, 0, -0.5 } },
    { 58, { 0, -0.9, 0, -1, 0, -0.3, 0, -0.4 } },
    { 59, { 0, -1, 0.15, -0.75, 0.1, -0.3, 0.1, -0.4 } },
    { 60, { 0.6, 0, 0, -0.5, 0.6, -1, 0, -0.5 } },
    { 61, { 0.6, -0.25, 0, -0.25, 0.6, -0.75, 0, -0.75 } },
    { 62, { 0, 0, 0.6, -0.5, 0, -1, 0.6, -0.5 } },
    { 63, { 0, -0.9, 0, -1, 0, -0.75, 0, -0.5, 0, -0.5, 0.3, -0.5, 0.3, 0, 0.3, -0.5, 0, 0, 0.3, 0 } },
    { 65, { 0, -1, 0, -0.3, 0.6, -0.3, 0.6, -1, 0.3, 0, 0, -0.3, 0.3, 0, 0.6, -0.3, 0, -0.5, 0.6, -0.5 } },
    { 66, { 0, -1, 0, 0, 0.447, 0, 0, 0, 0.447, 0, 0.6, -0.155, 0.6, -0.347, 0.6, -0.155, 0.448, -0.5, 0.6, -0.347, 0.448, -0.5, 0, -0.5, 0.6, -0.653, 0.448, -0.5, 0.6, -0.653, 0.6, -0.845, 0.447, -1, 0.6, -0.845, 0, -1, 0.447, -1 } },
    { 67, { 0.6, 0, 0, 0, 0, 0, 0, -1, 0.6, -1, 0, -1 } },
    { 68, { 0, 0, 0, -1, 0.447, 0, 0, 0, 0.447, 0, 0.6, -0.155, 0.6, -0.845, 0.6, -0.155, 0.6, -0.845, 0.447, -1, 0.447, -1, 0, -1 } },
    { 69, { 0, 0, 0.6, 0, 0, 0, 0, -1, 0.6, -1, 0, -1, 0, -0.5, 0.3, -0.5 } },
    { 70, { 0, 0, 0.6, 0, 0, 0, 0, -1, 0, -0.5, 0.3, -0.5 } },
    { 71, { 0.6, 0, 0, 0, 0, -1, 0, 0, 0.6, -1, 0.6, -0.5, 0.6, -1, 0, -1, 0.3, -0.5, 0.6, -0.5 } },
    { 72, { 0, 0, 0, -1, 0.6, 0, 0.6, -1, 0, -0.5, 0.6, -0.5 } },
    { 73, { 0.6, 0, 0, 0, 0.6, -1, 0, -1, 0.3, -1, 0.3, 0 } },
    { 74, { 0.6, -1, 0, -1, 0.6, -1, 0.6, 0, 0, -1, 0, -0.725 } },
    { 75, { 0, 0, 0, -1, 0, -0.5, 0.6, 0, 0, -0.5, 0.6, -1 } },
    { 76, { 0, 0, 0, -1, 0.6, -1, 0, -1 } },
    { 77, { 0, 0, 0, -1, 0, 0, 0.3, -0.5, 0.6, 0, 0.3, -0.5, 0.6, 0, 0.6, -1 } },
    { 78, { 0, 0, 0, -1, 0.6, 0, 0.6, -1, 0.6, -1, 0, 0 } },
    { 79, { 0, 0, 0, -1, 0.6, 0, 0.6, -1, 0.6, -1, 0, -1, 0.6, 0, 0, 0 } },
    { 80, { 0, 0, 0, -1, 0.6, 0, 0, 0, 0, -0.5, 0.6, -0.5, 0.6, 0, 0.6, -0.5 } },
    { 81, { 0.6, 0, 0, 0, 0, 0, 0, -1, 0.6, -1, 0, -1, 0.6, 0, 0.6, -1, 0.6, -1, 0.3, -0.5 } },
    { 82, { 0, 0, 0, -1, 0.6, 0, 0, 0, 0, -0.5, 0.6, -0.5, 0.6, 0, 0.6, -0.5, 0.15, -0.5, 0.6, -1 } },
    { 83, { 0, 0, 0.6, 0, 0, 0, 0, -0.5, 0.6, -0.5, 0, -0.5, 0.6, -1, 0.6, -0.5, 0.6, -1, 0, -1 } },
    { 84, { 0.6, 0, 0, 0, 0.3, -1, 0.3, 0 } },
    { 85, { 0, 0, 0, -1, 0.6, 0, 0.6, -1, 0.6, -1, 0, -1 } },
    { 86, { 0.3, -1, 0, 0, 0.3, -1, 0.6, 0 } },
    { 87, { 0, 0, 0, -1, 0, -1, 0.3, -0.5, 0.6, -1, 0.3, -0.5, 0.6, 0, 0.6, -1 } },
    { 88, { 0.6, -1, 0, 0, 0.6, 0, 0, -1 } },
    { 89, { 0, 0, 0.3, -0.5, 0.6, 0, 0.3, -0.5, 0.3, -1, 0.3, -0.5 } },
    { 90, { 0.6, 0, 0, 0, 0.6, 0, 0, -1, 0.6, -1, 0, -1 } },
    { 91, { 0.4, 0, 0.1, 0, 0.1, -1, 0.4, -1, 0.1, -1, 0.1, 0 } },
    { 92, { 0.6, -1, 0, 0 } },
    { 93, { 0.2, 0, 0.5, 0, 0.2, -1, 0.5, -1, 0.5, 0, 0.5, -1 } },
    { 94, { 0, -0.5, 0.3, 0, 0.6, -0.5, 0.3, 0 } },
    { 95, { 0, -1, 0.8, -1 } },
    { 96, { 0.5, -0.3, 0.3, 0 } },
    { 97, { 0.6, -0.5, 0, -0.5, 0, -0.75, 0, -1, 0.6, -0.5, 0.6, -1, 0, -0.75, 0.6, -0.75, 0.6, -1, 0, -1 } },
    { 98, { 0, 0, 0, -1, 0, -0.5, 0.6, -0.5, 0, -1, 0.6, -1, 0.6, -1, 0.6, -0.5 } },
    { 99, { 0.6, -0.5, 0, -0.5, 0, -1, 0, -0.5, 0.6, -1, 0, -1 } },
    { 100, { 0.6, -0.5, 0, -0.5, 0, -1, 0, -0.5, 0.6, -1, 0, -1, 0.6, -1, 0.6, 0 } },
    { 101, { 0.6, -0.5, 0, -0.5, 0, -1, 0, -0.5, 0.6, -0.5, 0.6, -0.75, 0, -0.75, 0.6, -0.75, 0.6, -1, 0, -1 } },
    { 102, { 0.15, -1, 0.15, -0.25, 0.45, 0, 0.3, 0, 0.15, -0.25, 0.3, 0, 0.45, -0.5, 0.15, -0.5 } },
    { 103, { 0, -0.5, 0.6, -0.5, 0, -1.25, 0.6, -1.25, 0.6, -1.25, 0.6, -0.5, 0, -1, 0, -0.5, 0, -1, 0.6, -1 } },
    { 104, { 0, 0, 0, -1, 0, -0.5, 0.6, -0.5, 0.6, -1, 0.6, -0.5 } },
    { 105, { 0.3, -1, 0.3, -0.5, 0.3, -0.25, 0.3, -0.15 } },
    { 106, { 0.3, -0.25, 0.3, -0.15, 0.3, -1.25, 0.3, -0.5, 0, -1.25, 0.3, -1.25 } },
    { 107, { 0, -1, 0, 0, 0, -0.75, 0.3, -0.5, 0, -0.75, 0.6, -1 } },
    { 108, { 0.3, -1, 0.3, 0 } },
    { 109, { 0.45, -0.5, 0, -0.5, 0.6, -0.75, 0.45, -0.5, 0.6, -0.75, 0.6, -1, 0, -1, 0, -0.5, 0.3, -1, 0.3, -0.5 } },
    { 110, { 0.45, -0.5, 0, -0.5, 0.6, -0.75, 0.45, -0.5, 0.6, -0.75, 0.6, -1, 0, -1, 0, -0.5 } },
    { 111, { 0, -1, 0, -0.5, 0.6, -0.5, 0, -0.5, 0.6, -1, 0, -1, 0.6, -1, 0.6, -0.5 } },
    { 112, { 0.6, -0.5, 0, -0.5, 0.6, -1, 0, -1, 0.6, -1, 0.6, -0.5, 0, -1.25, 0, -0.5 } },
    { 113, { 0.6, -0.5, 0, -0.5, 0.6, -1, 0, -1, 0, -1, 0, -0.5, 0.6, -1.25, 0.6, -0.5 } },
    { 114, { 0, -1, 0, -0.5, 0.6, -0.5, 0, -0.5, 0.6, -0.75, 0.6, -0.5 } },
    { 115, { 0.6, -0.5, 0, -0.5, 0, -0.75, 0, -0.5, 0.6, -0.75, 0, -0.75, 0.6, -0.75, 0.6, -1, 0.6, -1, 0, -1 } },
    { 116, { 0.3, -1, 0.3, -0.25, 0.45, -0.5, 0.15, -0.5, 0.3, -1, 0.45, -1 } },
    { 117, { 0, -1, 0, -0.5, 0.6, -1, 0.6, -0.5, 0.6, -1, 0, -1 } },
    { 118, { 0.3, -1, 0, -0.5, 0.3, -1, 0.6, -0.5 } },
    { 119, { 0.15, -1, 0, -0.5, 0.3, -0.75, 0.15, -1, 0.3, -0.75, 0.45, -1, 0.45, -1, 0.6, -0.5 } },
    { 120, { 0.6, -1, 0, -0.5, 0, -1, 0.6, -0.5 } },
    { 121, { 0, -1.25, 0.6, -0.5, 0.3, -0.875, 0, -0.5 } },
    { 122, { 0.6, -0.5, 0, -0.5, 0, -1, 0.6, -0.5, 0.6, -1, 0, -1 } },
};
